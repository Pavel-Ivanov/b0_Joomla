<?phpdefined('_JEXEC') or die('Restricted access');JImport('logan.pricehelper');$params = $this->tmpl_params['list'];$user = $this->user;$user_rights = $user->getAuthorisedViewLevels();$app = JFactory::getApplication();$cart = $app->getUserState('cart');//var_dump($cart);$cart = isset($cart) ? $cart : array();//echo var_dump($app->getUserState('cart'));?><?php foreach ($this->items as $item):?>	<article class="uk-article uk-visible-hover">		<!-- Панель управления -->		<?php if($user->get('id')) {			echo '<div class="uk-hidden uk-button-group uk-float-right" >';				//echo bookmark($item, $this->submission_types[$item->type_id], $params);				//echo HTMLFormatHelper::follow($item, $this->section);				//echo compare($item, $this->submission_types[$item->type_id], $this->section);				if ($item->controls) { ?>					<div class="uk-float-right">						<div class="uk-button-dropdown" data-uk-dropdown="{mode:'click'}">							<button class="uk-button-link">                                <?= HTMLFormatHelper::icon('gear.png');  ?>							</button>							<div class="uk-dropdown uk-dropdown-small">								<ul class="uk-nav uk-nav-dropdown uk-panel uk-panel-box uk-panel-box-secondary">									<?= list_controls($item->controls); ?>								</ul>							</div>						</div>					</div>				<?php }			echo '</div>';		} ?>		<!-- Запчасть -->		<h2 class="uk-article-title">			<a href="<?= JRoute::_($item->url);?>" target="_blank">				<?= $item->title?>			</a>			<?= CEventsHelper::showNum('record', $item->id);?>		</h2>		<p class="ls-sub-title">для <?= $item->fields_by_id[42]->result;?> </p>		<div class="uk-grid">			<div class="uk-width-medium-2-10 uk-width-small-1-2">				<?php if(isset($item->fields_by_id[28])) echo $item->fields_by_id[28]->result;?>			</div>			<div class="uk-width-medium-4-10 uk-hidden-small">                <?php if (isset($item->fields_by_id[33]))					echo '<p><strong>Производитель: </strong>'.$item->fields_by_id[33]->result.'</p>';				?>                <?php if (isset($item->fields_by_id[66])) {					echo '<p><strong>Код товара: </strong>'.$item->fields_by_id[66]->result;                    if ($item->fields_by_id[96]->value == 1)                        echo ' / <span class="uk-text-danger" data-uk-tooltip title="Фактическая стоимость уточняется при заказе">под заказ</span>';                    echo '</p>';				} ?>				<?php if (isset($item->fields_by_id[60]))					echo '<p class="ls-sub-title">'.$item->fields_by_id[60]->result.'</p>';				?>			</div>			<div class="uk-width-medium-4-10 uk-width-small-1-2">                <?php                /** @var integer $item */                $item_id = $item->id;                /** @var boolean $is_featured */                $is_featured = (boolean) $item->featured;                /** @var boolean $is_by_order */                $is_by_order = ($item->fields_by_id[96]->value == 1) ? true : false;                /** @var boolean $is_general */                $is_general = (!$is_featured && !$is_by_order) ? true : false;                /** @var boolean $is_original */                $is_original = $item->fields_by_id[98]->value == 1 ? true : false;                $prices = ['general'=> $item->fields_by_id[30]->value,                           'special'=> isset($item->fields_by_id[32]) ? ($item->fields_by_id[32]->value) : 0];                if ($is_featured) {	                $prices['delivery'] = isset($item->fields_by_id[32]) ? ($item->fields_by_id[32]->value) : 0;                }                else {	                if ($is_original) {		                $prices['delivery'] = round($item->fields_by_id[30]->value * 0.95, -1);	                }	                else {		                $prices['delivery'] = round($item->fields_by_id[30]->value * 0.90, -1);	                }                }                ?>                <?php if ($is_by_order)                {                    echo '<p class="uk-h4">Цена: уточняется при заказе</p>';                }                elseif ($is_featured)                {                    echo '<p class="ls-price-special uk-text-danger">Специальная цена: ' . render_price($prices['special']) . '</p>';	                echo '<p class="ls-price-second">Обычная цена: <del>' . render_price($prices['general']) . '</del></p>';				    echo '<p>Вы экономите ' . render_economy($prices['general'], $prices['special']).'</p>';				}                else                {	                echo '<p class="ls-price-second">Цена: ' . render_price($prices['general']) . '</p>';	                echo '<p class="ls-price-special uk-text-danger">Цена при заказе доставки: ' . render_price($prices['delivery']) . '</p>';	                echo '<p>Вы экономите ' . render_economy($prices['general'], $prices['delivery']).'</p>';                } ?>                <?php if (isset($item->fields_by_id[26]) && in_array($item->fields_by_id[26]->params->get('core.field_view_access'), $user_rights)) { ?>                    <hr class="uk-grid-divider">                    <p>						<strong><?= $item->fields_by_id[26]->label; ?>: </strong><?= $item->fields_by_id[26]->result;?>					</p>				<?php } ?>				<!-- Корзина -->				<div class="uk-grid"><!--					<div class="uk-width-medium-1-1 uk-hidden-small">-->					<div class="uk-width-medium-1-1 uk-hidden-small">					<?php $in_cart = array_key_exists($item_id, $cart);					$quant = ($in_cart) ? $cart[$item_id]['quantity'] : 0;					?>					<?php if (!$is_by_order) { ?>						<div id="cart<?= $item_id;?>" class="uk-vertical-align-middle">							<input type="number" id="cart-quantity<?= $item_id;?>"								<?= !$in_cart ? 'min="1"' : 'min="0"';?>								<?= !$in_cart ? 'value="1"' : 'value="0"';?>							    style="margin-bottom: auto; width: 50px;" />							<button type="button" class="cart-add" id="cart-add<?= $item_id;?>"							        data-item-id = "<?= $item_id;?>"							        data-in-cart="<?= $in_cart ? $in_cart : 0;?>">								<?= $in_cart ? 'Изменить' : 'В корзину';?>							</button>							<a href="<?= JRoute::_('index.php?option=com_lscart'); ?>">								<span id="cart-already<?= $item_id;?>" <?= (!$in_cart) ? "hidden" : "";?>>Сейчас в корзине								<span class="badge" style="font-size: 15px;" ><?= $quant;?></span></span>							</a>						</div>					<?php } ?>					</div>				</div>			</div>		</div>	</article><?php endforeach;?><hr class="uk-article-divider"><script>	'use strict';	let elem = document.getElementsByClassName('cart-add');	for (let i = 0; i < elem.length; i++) {		elem[i].addEventListener('click' , cartAdd);	}	function cartAdd(event) {		let target = event.target;		//Получаем значения ID элемента и количества		let itemId = target.getAttribute("data-item-id");		let formQuantity = document.getElementById('cart-quantity'+itemId);		let itemQuantity = formQuantity.value;		let inCart = target.getAttribute("data-in-cart");		//console.log('typeof itemQuantity:' + typeof itemQuantity + ' / ' + itemQuantity);		//console.log('typeof inCart:' + typeof inCart + ' / ' + inCart);		target.innerHTML = '<img src="<?= JUri::root(TRUE);?>/components/com_cobalt/images/load.gif"/>';		let xhr = new XMLHttpRequest();		let body = '';		let task = '';		if (itemQuantity === '0') { // Удаляем			body = 'item_id='+itemId;			task = 'index.php?option=com_lscart&task=cart.delete';		}		else {  // Изменяем			body = 'item_id='+itemId+'&item_quantity='+itemQuantity;			task = 'index.php?option=com_lscart&task=cart.add';		}		//console.log('task: ' + task);		//console.log('body: ' + body);		xhr.open("POST", task, true);		xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');		xhr.send(body);		xhr.onreadystatechange = function() {			if (this.readyState != 4) {				return;			}			if (xhr.status != 200) {				alert(xhr.status + ': ' + xhr.statusText);			}			else {				//Кнопка - target				target.setAttribute("data-in-cart", itemQuantity);				if (itemQuantity === '0') { //Удаляем					target.innerHTML = 'В корзину';				}				else {  // Изменяем					//if (inCart === '0') {					target.innerHTML = 'Изменить';					//}				}				//Уже в корзине- cartAlready				let cartAlready = document.getElementById('cart-already'+itemId);				if (itemQuantity === '0') { // Удаляем					cartAlready.hidden = true;				}				else {  // Изменяем					cartAlready.lastChild.textContent = formQuantity.value;					//if (inCart === '0') {						cartAlready.hidden = false;					//}				}				//Модуль корзины				let cartCount = Number(document.getElementById('cart-count').textContent);				//console.log('typeof cartCount:' + typeof cartCount + ' / ' + cartCount);				//console.log('typeof String(cartCount):' + typeof String(cartCount) + ' / ' + String(cartCount));				if (itemQuantity === '0') {					document.getElementById('cart-count').textContent = String(cartCount - 1);				}				else {					if (inCart === '0') {   // Это новый элемент в корзине						document.getElementById('cart-count').textContent = String(cartCount + 1);					}				}				//Количество- itemQuantity, определено выше				if (itemQuantity === '0') { // Удаляем					document.getElementById('cart-quantity'+itemId).value = 1;					document.getElementById('cart-quantity'+itemId).setAttribute('min', 1);				}				else {  // Изменяем					document.getElementById('cart-quantity'+itemId).value = 0;					document.getElementById('cart-quantity'+itemId).setAttribute('min', 0);				}			}		}	}</script>