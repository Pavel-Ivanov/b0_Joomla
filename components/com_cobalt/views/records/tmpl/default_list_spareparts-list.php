<?phpdefined('_JEXEC') or die();JImport('b0.Sparepart.SparepartIds');JImport('b0.Sparepart.SparepartKeys');JImport('b0.pricehelper');//JImport('b0.fixtures');$doc = JFactory::getDocument();$doc->addScript('/media/b0/js/jquery-ias.min.js');$params = $this->tmpl_params['list'];$user = $this->user;$user_rights = $user->getAuthorisedViewLevels();$app = JFactory::getApplication();$cart = $app->getUserState('cart');$cart = isset($cart) ? $cart : array();$yaCounter = 'yaCounter14943637';$yaCounterGoal = 'ADDTOCART';?><div id="articles" class="uk-margin-top">    <hr class="uk-article-didvider">    <?php foreach ($this->items as $item):?>		<?php		/** @var integer $item */		$item_id = $item->id;		/** @var array $fields */		$fields = $item->fields_by_key;		/** @var boolean $is_featured */		$is_featured = ($fields[SparepartKeys::KEY_IS_SPECIAL]->value == 1) ? true : false;		/** @var boolean $is_by_order */		$is_by_order = ($fields[SparepartKeys::KEY_IS_BY_ORDER]->value == 1) ? true : false;		/** @var boolean $is_general */		$is_general = (!$is_featured && !$is_by_order) ? true : false;		/** @var boolean $is_original */		$is_original = $fields[SparepartKeys::KEY_IS_ORIGINAL]->value == 1 ? true : false;		$prices = ['general'=> $fields[SparepartKeys::KEY_PRICE_GENERAL]->value,		           'special'=> isset($fields[SparepartKeys::KEY_PRICE_SPECIAL]) ? ($fields[SparepartKeys::KEY_PRICE_SPECIAL]->value) : 0,		           'delivery'=> isset($fields[SparepartKeys::KEY_PRICE_DELIVERY]) ? ($fields[SparepartKeys::KEY_PRICE_DELIVERY]->value) : 0];		?>        <article class="uk-article uk-visible-hover">            <!-- Панель управления -->			<?php if($item->controls){				echo JLayoutHelper::render('b0.controls-list', $item->controls);			}?>            <!-- Запчасть -->            <h2 class="uk-article-title uk-text-center-small">                <a href="<?= JRoute::_($item->url);?>" target="_blank">					<?= $item->title?>                </a>            </h2>            <div class="uk-grid" data-uk-grid-margin data-uk-grid-match>                <div class="uk-width-medium-2-10 uk-text-center-small">					<?php if(isset($fields[SparepartKeys::KEY_IMAGE])) echo $fields[SparepartKeys::KEY_IMAGE]->result;?>                </div>                <div class="uk-width-medium-4-10 uk-text-center-small">					<?php if (isset($fields[SparepartKeys::KEY_MODEL]))						echo '<p><strong>Модели: </strong>'.$fields[SparepartKeys::KEY_MODEL]->result.'</p>';					?>					<?php if (isset($fields[SparepartKeys::KEY_MOTOR]))						echo '<p><strong>Моторы: </strong>'.$fields[SparepartKeys::KEY_MOTOR]->result.'</p>';					?>     					<?php if (isset($fields[SparepartKeys::KEY_MANUFACTURER]))						echo '<p><strong>Производитель: </strong>'.$fields[SparepartKeys::KEY_MANUFACTURER]->result.'</p>';					?>					<?php if (isset($fields[SparepartKeys::KEY_PRODUCT_CODE])) {						echo '<p><strong>Код товара: </strong>'.$fields[SparepartKeys::KEY_PRODUCT_CODE]->result;						echo '</p>';					} ?>					<?php if (isset($fields[SparepartKeys::KEY_SUBTITLE]))						echo '<p class="ls-sub-title">'.$fields[SparepartKeys::KEY_SUBTITLE]->result.'</p>';					?>                </div>                <div class="uk-width-medium-4-10 uk-text-center-small" data-uk-grid-match>                    <div class="uk-panel uk-panel-box uk-vertical-align-middle">						<?php if ($is_by_order){							echo '<p class="ls-price-second">Ожидается поступление</p>';							echo '<p class="uk-h5 uk-text-muted">Цена уточняется при заказе</p>';						}                        elseif ($is_featured){							echo '<p class="ls-price-special uk-text-danger">Специальная цена: ' . render_price($prices['special']) . '</p>';							echo '<p class="ls-price-second">Обычная цена: <del>' . render_price($prices['general']) . '</del></p>';							echo '<p>Вы экономите ' . render_economy($prices['general'], $prices['special']).'</p>';						}						else{							echo '<p class="ls-price-second">Цена: ' . render_price($prices['general']) . '</p>';							echo '<p class="ls-price-special uk-text-danger">Цена при доставке по СПб: ' . render_price($prices['delivery']) . '</p>';							echo '<p>Вы экономите ' . render_economy($prices['general'], $prices['delivery']).'</p>';						} ?>                        <!-- Корзина -->                        <div class="uk-grid">                            <div class="uk-width-medium-1-1">								<?php $in_cart = array_key_exists($item_id, $cart);								$quant = ($in_cart) ? $cart[$item_id]['quantity'] : 0;								?>								<?php if (!$is_by_order) { ?>                                    <div id="cart<?= $item_id;?>" class="uk-vertical-align-middle">                                        <input type="number" id="cart-quantity<?= $item_id;?>"											<?= !$in_cart ? 'min="1"' : 'min="0"';?>											<?= !$in_cart ? 'value="1"' : 'value="0"';?>                                               style="margin-bottom: auto; width: 50px;" />                                        <button type="button" class="cart-add" id="cart-add<?= $item_id;?>"                                                data-item-id = "<?= $item_id;?>"                                                data-in-cart="<?= $in_cart ? $in_cart : 0;?>"<!--                                                onclick="--><?//= $yaCounter;?>//.reachGoal('<?//= $yaCounterGoal;?>//')">											<?= $in_cart ? 'Изменить' : '<i class="uk-icon-cart-plus uk-margin-right"></i>В корзину';?>                                        </button>                                        <a href="<?= JRoute::_('cart'); ?>">                                            <span id="cart-already<?= $item_id;?>" <?= (!$in_cart) ? "hidden" : "";?>>Сейчас в корзине                                            <span class="badge" style="font-size: 15px;" ><?= $quant;?></span></span>                                        </a>                                    </div>								<?php } ?>                            </div>                        </div>                    </div>					<?php if (isset($fields[SparepartKeys::KEY_VENDOR_CODE]) && in_array($fields[SparepartKeys::KEY_VENDOR_CODE]->params->get('core.field_view_access'), $user_rights)) { ?>                        <hr class="uk-grid-divider">                        <p>                            <strong><?= $fields[SparepartKeys::KEY_VENDOR_CODE]->label; ?>: </strong><?= $fields[SparepartKeys::KEY_VENDOR_CODE]->result;?>                        </p>					<?php } ?>                </div>            </div>        </article>	<?php endforeach;?></div><div id="pagination-counter" class="uk-text-center uk-text-small uk-margin-top"></div><hr class="uk-article-divider"><div class="pagination uk-text-center">	<?= str_replace('<ul>', '<ul class="pagination-list">', $this->pagination->getPagesLinks());?></div><script>	'use strict';    let ias = jQuery.ias({        container:  "#articles",        item:       ".uk-article",        pagination: ".pagination",        next:       ".pagination-next a"    });    ias.extension(new IASSpinnerExtension({        html: '<div class="ias-spinner uk-text-center"><i class="uk-icon-refresh uk-icon-spin"></i></div>'    }));    ias.extension(new IASTriggerExtension({        text: 'Показать еще 10',        html: '<div class="ias-trigger ias-trigger-next uk-text-center"><a class="uk-button uk-button-primary">{text}</a></div>'    }));    ias.extension(new IASNoneLeftExtension({        text: 'Конец списка'    }));    ias.extension(new IASPagingExtension());    ias.on('rendered', function(items) {        let $items = $(items);        for (let i = 0; i < items.length; i++) {            items[i].addEventListener('click' , cartAdd);        }    });    ias.on('pageChange', function(pageNum, scrollOffset, url) {       document.getElementById('pagination-counter').textContent = 'Показано страниц: ' + pageNum + ' из ' + <?= $this->pagination->pagesTotal;?>;    });    let elem = document.getElementsByClassName('cart-add');	for (let i = 0; i < elem.length; i++) {		elem[i].addEventListener('click' , cartAdd);		elem[i].addEventListener('click' , yaCounter);	}	function cartAdd(event) {		let target = event.target;		//Получаем значения ID элемента и количества		let itemId = target.getAttribute("data-item-id");		let formQuantity = document.getElementById('cart-quantity'+itemId);		let itemQuantity = formQuantity.value;		let inCart = target.getAttribute("data-in-cart");		target.innerHTML = '<i class="uk-icon-refresh uk-icon-spin"></i>';		let xhr = new XMLHttpRequest();		let body = '';		let task = '';		if (itemQuantity === '0') { // Удаляем			body = 'item_id='+itemId;			task = 'index.php?option=com_lscart&task=cart.delete';		}		else {  // Изменяем            body = 'item_id='+itemId+'&item_quantity='+itemQuantity;			task = 'index.php?option=com_lscart&task=cart.add';		}		xhr.open("POST", task, true);		xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');		xhr.send(body);		xhr.onreadystatechange = function() {			if (this.readyState !== 4) {				return;			}			if (xhr.status !== 200) {				alert(xhr.status + ': ' + xhr.statusText);			}			else {				//Кнопка - target				target.setAttribute("data-in-cart", itemQuantity);				if (itemQuantity === '0') { //Удаляем					target.innerHTML = 'В корзину';				}				else {  // Изменяем					target.innerHTML = 'Изменить';				}				//Уже в корзине- cartAlready				let cartAlready = document.getElementById('cart-already'+itemId);				if (itemQuantity === '0') { // Удаляем					cartAlready.hidden = true;				}				else {  // Изменяем					cartAlready.lastChild.textContent = formQuantity.value;                    cartAlready.hidden = false;				}				//Модуль корзины				let cartCount = Number(document.getElementById('cart-count').textContent);				if (itemQuantity === '0') {					document.getElementById('cart-count').textContent = String(cartCount - 1);				}				else {					if (inCart === '0') {   // Это новый элемент в корзине						document.getElementById('cart-count').textContent = String(cartCount + 1);					}				}				//Количество- itemQuantity, определено выше				if (itemQuantity === '0') { // Удаляем					document.getElementById('cart-quantity'+itemId).value = 1;					document.getElementById('cart-quantity'+itemId).setAttribute('min', 1);				}				else {  // Изменяем					document.getElementById('cart-quantity'+itemId).value = 0;					document.getElementById('cart-quantity'+itemId).setAttribute('min', 0);				}			}		}	}		function yaCounter(event) {        if (typeof <?= $yaCounter;?> !== "undefined" && <?= $yaCounter;?> !== null) {            <?= $yaCounter;?>.reachGoal('<?= $yaCounterGoal;?>');        }    }</script>